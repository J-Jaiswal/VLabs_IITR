<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Earthquake Location Simulator — Improved</title>

    <!-- Bootstrap (same as original) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      crossorigin="anonymous"
    />

    <!-- D3 & Numeric.js (same libs, versions pinned) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>

    <style>
      body {
        background: #f7f7f9;
      }
      .panel {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 16px;
      }
      .panel h5 {
        margin-bottom: 12px;
      }
      .small-label {
        font-size: 12px;
        color: #555;
      }
      .ctrl {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .ctrl .form-control,
      .ctrl .form-select {
        max-width: 160px;
      }
      .legend-swatch {
        width: 14px;
        height: 14px;
        border-radius: 2px;
        display: inline-block;
        margin-right: 6px;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .hint {
        font-size: 12px;
        color: #666;
      }
      .badge-lite {
        background: #eef2ff;
        color: #3730a3;
      }
      .map-wrap {
        position: relative;
      }
      .overlay-note {
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 12px;
        background: #ffffffcc;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .btn-toggle {
        border: 1px solid #e5e7eb;
      }
      .kpi {
        font-size: 12px;
        color: #444;
      }
      .kpi strong {
        font-size: 14px;
      }
      /* Colorbar axis */
      .colorbar-axis text {
        font-size: 11px;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="mb-3">
        <h3 class="mb-1">Earthquake Location Simulator</h3>
        <!-- <div class="hint">
          Drag stations, add/remove stations, adjust noise/velocity, and watch
          the inversion converge with uncertainties.
        </div> -->
      </div>

      <!-- Controls -->
      <div class="panel mb-3">
        <h5>Inputs</h5>
        <div class="ctrl">
          <div>
            <label class="small-label">Stations</label>
            <input
              id="numStations"
              type="number"
              class="form-control"
              min="0"
              step="1"
              value="6"
            />
          </div>
          <div>
            <label class="small-label">Event X (km)</label>
            <input id="xInput" type="number" class="form-control" value="10" />
          </div>
          <div>
            <label class="small-label">Event Y (km)</label>
            <input id="yInput" type="number" class="form-control" value="5" />
          </div>
          <div>
            <label class="small-label">Event Z (km)</label>
            <input id="zInput" type="number" class="form-control" value="0" />
          </div>
          <div>
            <label class="small-label"
              >True P-wave velocity v<sub>true</sub> (km/s)</label
            >
            <!-- NEW: slider tied to synthetic data -->
            <input
              id="vTrue"
              type="range"
              class="form-range"
              min="2"
              max="8"
              step="0.1"
              value="5"
            />
            <div class="hint">
              <span class="badge rounded-pill bg-light text-dark" id="vTrueLbl"
                >5.0</span
              >
            </div>
          </div>
          <div>
            <label class="small-label"
              >Start velocity v<sub>start</sub> (km/s)</label
            >
            <!-- NEW: separate start velocity for inversion bias demos -->
            <input
              id="vStart"
              type="number"
              class="form-control"
              value="4.0"
              step="0.1"
            />
          </div>
          <div>
            <label class="small-label">Noise σ (s)</label>
            <!-- NEW: noise control -->
            <input
              id="sigma"
              type="number"
              class="form-control"
              value="0.10"
              step="0.01"
              min="0"
            />
          </div>
          <div>
            <label class="small-label">Outlier</label>
            <!-- NEW: outlier toggle -->
            <select id="outlier" class="form-select">
              <option value="none" selected>None</option>
              <option value="mild">Mild (3σ)</option>
              <option value="strong">Strong (6σ)</option>
            </select>
          </div>
          <div>
            <label class="small-label">Damping λ</label>
            <!-- NEW: damping for Tikhonov -->
            <input
              id="lambda"
              type="number"
              class="form-control"
              value="0.10"
              step="0.01"
              min="0"
            />
          </div>
          <div class="d-flex align-items-end gap-2">
            <button id="btnGenerate" class="btn btn-outline-primary">
              Generate stations
            </button>
            <button id="btnRun" class="btn btn-primary">Run simulation</button>
            <button id="btnReset" class="btn btn-outline-secondary">
              Reset
            </button>
          </div>
        </div>
        <div class="mt-2 hint">
          <span class="legend-swatch" style="background: #111"></span>Station
          <span class="legend-swatch" style="background: #e11d48"></span>True
          event
          <span class="legend-swatch" style="background: #0ea5e9"></span
          >Estimated event (after inversion)
          <span class="legend-swatch" style="background: #a78bfa"></span>1-σ
          ellipse
        </div>
      </div>

      <!-- Graphs -->
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="panel">
            <h5>Map: Stations, Event, and Uncertainty</h5>
            <div class="map-wrap">
              <svg id="map" width="540" height="420"></svg>
              <div class="overlay-note">
                Drag stations. Add mode:
                <button id="toggleAdd" class="btn btn-sm btn-toggle">
                  OFF
                </button>
              </div>
            </div>
            <div class="row mt-2 gx-3">
              <div class="col">
                <div class="kpi">Iterations: <strong id="kIter">—</strong></div>
                <div class="kpi">
                  RMS residual (s): <strong id="kRMS">—</strong>
                </div>
              </div>
              <div class="col">
                <div class="kpi">cond(G): <strong id="kCond">—</strong></div>
                <div class="kpi">λ: <strong id="kLambda">—</strong></div>
              </div>
            </div>
            <div class="hint mt-2">
              Alt/Option+click a station to remove it.
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="panel">
            <h5>Misfit Map (forward scan)</h5>
            <svg id="misfit" width="540" height="420"></svg>
            <div class="hint mt-2">
              Misfit computed on a grid with t<sub>0</sub> optimized for each
              gridpoint and v fixed to v<sub>start</sub>.
            </div>
          </div>
        </div>

        <div class="col-lg-12">
          <div class="panel">
            <!-- <h5>Convergence</h5> -->
            <svg id="conv" width="1120" height="220"></svg>
          </div>
        </div>
      </div>
    </div>

    <script src="index_eXP2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
