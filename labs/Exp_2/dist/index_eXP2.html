<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Earthquake Location Simulator — Improved</title>

    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      crossorigin="anonymous"
    />

    <!-- D3 & numeric.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>

    <style>
      body {
        background: #f7f7f9;
      }
      .panel {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 12px;
      }
      .panel h5 {
        margin-bottom: 12px;
      }
      .small-label {
        font-size: 12px;
        color: #555;
      }
      .ctrl {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .ctrl .form-control,
      .ctrl .form-select {
        max-width: 160px;
      }

      .legend-swatch {
        width: 14px;
        height: 14px;
        border-radius: 2px;
        display: inline-block;
        margin-right: 6px;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .modebar .btn {
        border-radius: 999px;
        padding: 6px 12px;
        border-color: #e5e7eb;
      }
      .modebar .btn:hover {
        background: #f3f4f6;
      }
      .modebar .btn.active {
        background: #e8edff;
        border-color: #c7d2fe;
        color: #0b1220;
        box-shadow: none;
      }

      .kpi {
        font-size: 12px;
        color: #444;
      }
      .kpi strong {
        font-size: 14px;
      }
      .colorbar-axis text {
        font-size: 11px;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="mb-3">
        <h3 class="mb-1">Earthquake Location Simulator</h3>
      </div>

      <!-- Inputs -->
      <div class="panel mb-3">
        <h5>Inputs</h5>
        <div class="ctrl">
          <div>
            <label class="small-label">Stations</label>
            <!-- Clamp in UI -->
            <input
              id="numStations"
              type="number"
              class="form-control"
              min="3"
              max="15"
              step="1"
              value="6"
            />
          </div>
          <div>
            <label class="small-label">Event X (km)</label>
            <input id="xInput" type="number" class="form-control" value="10" />
          </div>
          <div>
            <label class="small-label">Event Y (km)</label>
            <input id="yInput" type="number" class="form-control" value="5" />
          </div>
          <div>
            <label class="small-label">Event Z (km)</label>
            <input id="zInput" type="number" class="form-control" value="8" />
          </div>
          <div>
            <label class="small-label"
              >True P-wave velocity v<sub>true</sub> (km/s)</label
            >
            <input
              id="vTrue"
              type="range"
              class="form-range"
              min="2"
              max="8"
              step="0.1"
              value="5"
            />
            <div class="hint">
              <span class="badge rounded-pill bg-light text-dark" id="vTrueLbl"
                >5.0</span
              >
            </div>
          </div>
          <div>
            <label class="small-label"
              >Start velocity v<sub>start</sub> (km/s)</label
            >
            <input
              id="vStart"
              type="number"
              class="form-control"
              value="4.0"
              step="0.1"
            />
          </div>
          <div>
            <label class="small-label">Noise σ (s)</label>
            <input
              id="sigma"
              type="number"
              class="form-control"
              value="1.5"
              step="0.1"
              min="0"
            />
          </div>
          <div>
            <label class="small-label">Outlier</label>
            <select id="outlier" class="form-select">
              <option value="none" selected>None</option>
              <option value="mild">Mild (3σ)</option>
              <option value="strong">Strong (6σ)</option>
            </select>
          </div>
          <div>
            <label class="small-label">Damping λ</label>
            <input
              id="lambda"
              type="number"
              class="form-control"
              value="0.10"
              step="0.01"
              min="0"
            />
          </div>
          <!-- NEW -->
          <div>
            <label class="small-label">Max iterations</label>
            <input
              id="maxIter"
              type="number"
              class="form-control"
              value="8"
              min="1"
              max="50"
              step="1"
            />
          </div>

          <div class="d-flex align-items-end gap-2">
            <button id="btnGenerate" class="btn btn-outline-primary">
              Generate stations
            </button>
            <button id="btnRun" class="btn btn-primary">Run simulation</button>
            <button id="btnReset" class="btn btn-outline-secondary">
              Reset
            </button>
          </div>
        </div>

        <div class="mt-2 hint">
          <span class="legend-swatch" style="background: #111"></span>Station
          <span class="legend-swatch" style="background: #e11d48"></span>True
          event
          <span class="legend-swatch" style="background: #0ea5e9"></span
          >Estimated event (after inversion)
          <span class="legend-swatch" style="background: #f59e0b"></span
          >Uncertainty Ellipse
        </div>
      </div>

      <!-- Layout -->
      <!-- === Layout: 70% (Arrivals) | 30% (Map + Misfit stacked) === -->
      <!-- === Layout: 60% (Arrivals) | 40% (Map + Misfit stacked) === -->
      <div
        class="g-3"
        style="
          display: grid;
          grid-template-columns: 60% 40%;
          grid-template-rows: auto auto;
          grid-template-areas:
            'arrivals side'
            'conv conv';
          gap: 12px;
        "
      >
        <!-- LEFT: Station Arrivals (60%) -->
        <div class="panel" style="grid-area: arrivals; margin-bottom: 0">
          <h5>Station Arrivals</h5>
          <div
            id="wavesWrap"
            style="border: 1px solid #e5e7eb; border-radius: 6px"
          >
            <!-- responsive width; your JS controls height per station -->
            <svg id="waves" style="width: 100%; display: block"></svg>
          </div>
        </div>

        <!-- RIGHT: Map (top) + Misfit (bottom) stacked (40%) -->
        <!-- RIGHT: Map (top) + Misfit (bottom) stacked (reduced height) -->
        <div
          style="
            grid-area: side;
            display: grid;
            grid-template-rows: auto auto;
            gap: 12px;
          "
        >
          <!-- Stations, True Event, Estimated Event -->
          <div class="panel" style="margin: 0">
            <div class="modebar d-flex align-items-center gap-2 mt-2">
              <div
                class="btn-group btn-group-sm"
                role="group"
                aria-label="Edit mode"
              >
                <button id="modeAdd" type="button" class="btn btn-light active">
                  Add
                </button>
                <button id="modeMove" type="button" class="btn btn-light">
                  Move
                </button>
                <button id="modeRemove" type="button" class="btn btn-light">
                  Remove
                </button>
              </div>
              <small class="text-muted ms-2"
                >Add: click • Move: drag • Remove: click</small
              >
            </div>

            <!-- Reduced height -->
            <svg
              id="map"
              width="460"
              height="420"
              style="display: block; margin-inline: auto"
            ></svg>

            <div class="row mt-2 gx-3">
              <div class="col">
                <div class="kpi">Iterations: <strong id="kIter">—</strong></div>
                <div class="kpi">
                  RMS residual (s): <strong id="kRMS">—</strong>
                </div>
              </div>
            </div>
          </div>

          <!-- Misfit Map (reduced size too) -->
          <div class="panel" style="margin: 0">
            <h5>Misfit Map</h5>
            <svg
              id="misfit"
              width="420"
              height="420"
              style="display: block; margin-inline: auto"
            ></svg>
          </div>
        </div>

        <!-- FULL-WIDTH: Convergence -->
        <div class="panel" style="grid-area: conv; margin-top: 4px">
          <h5>Convergence</h5>
          <div
            style="
              position: relative;
              width: 100%;
              padding-left: 28px;
              padding-bottom: 22px;
            "
          >
            <svg
              id="conv"
              style="width: 100%; height: 220px; display: block"
            ></svg>
            <div
              style="
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%) rotate(-90deg);
                transform-origin: left top;
                font-size: 12px;
                color: #666;
                white-space: nowrap;
              "
            >
              Residual / RMS (s)
            </div>
            <div
              style="
                position: absolute;
                left: 50%;
                bottom: 0;
                transform: translateX(-50%);
                font-size: 12px;
                color: #666;
                white-space: nowrap;
              "
            >
              Iterations
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script src="index_eXP2.js"></script>
  </body>
</html>
